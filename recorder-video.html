<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-start { background: #48bb78; color: white; }
        .btn-stop { background: #f56565; color: white; }
        .btn-replay { background: #667eea; color: white; }
        .btn-export { background: #ed8936; color: white; }
        
        button:hover { transform: translateY(-2px); }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .recording { background: #fed7d7; color: #c53030; }
        .recording.show { display: block; }
        
        .demo-area {
            padding: 30px;
            background: #f7fafc;
            border-radius: 8px;
            min-height: 300px;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-top: 5px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #ebf8ff;
            padding: 15px;
            border-radius: 8px;
        }
        
        .replay-container {
            width: 100%;
            height: 500px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        .interactions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .interaction-btn {
            padding: 8px 16px;
            background: #edf2f7;
            color: #4a5568;
        }
        
        @media (max-width: 768px) {
            .controls { flex-direction: column; }
            button { width: 100%; }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¥ åŸç”ŸJSæ— æ„Ÿå½•å±æ¼”ç¤º</h1>
        
        <div class="section">
            <h2>ğŸ“ æ¼”ç¤ºåŒºåŸŸ</h2>
            <div class="demo-area" id="demoArea">
                <p>åœ¨æ­¤åŒºåŸŸè¿›è¡Œä»»æ„æ“ä½œï¼Œæ‰€æœ‰äº¤äº’éƒ½ä¼šè¢«å½•åˆ¶ï¼š</p>
                
                <div class="form-group">
                    <label>å§“åï¼š</label>
                    <input type="text" id="nameInput" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                
                <div class="form-group">
                    <label>é‚®ç®±ï¼š</label>
                    <input type="email" id="emailInput" placeholder="è¯·è¾“å…¥é‚®ç®±">
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©åŸå¸‚ï¼š</label>
                    <select id="citySelect">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="beijing">åŒ—äº¬</option>
                        <option value="shanghai">ä¸Šæµ·</option>
                        <option value="guangzhou">å¹¿å·</option>
                        <option value="shenzhen">æ·±åœ³</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>å¤‡æ³¨ï¼š</label>
                    <textarea id="notes" rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."></textarea>
                </div>
                
                <div class="interactions">
                    <button class="interaction-btn" onclick="addDemoItem()">â• æ·»åŠ é¡¹ç›®</button>
                    <button class="interaction-btn" onclick="changeDemoColor()">ğŸ¨ éšæœºé¢œè‰²</button>
                    <button class="interaction-btn" onclick="clearDemoItems()">ğŸ—‘ï¸ æ¸…ç©ºåˆ—è¡¨</button>
                </div>
                
                <div id="itemList"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>ğŸ›ï¸ å½•åˆ¶æ§åˆ¶</h2>
            <div class="controls">
                <button class="btn-start" onclick="startNativeRecording()">å¼€å§‹æ— æ„Ÿå½•åˆ¶</button>
                <button class="btn-stop" onclick="stopNativeRecording()">åœæ­¢å½•åˆ¶</button>
                <button class="btn-replay" onclick="replayRecording()" id="replayBtn" disabled>å›æ”¾å½•åˆ¶</button>
                <button class="btn-export" onclick="exportRecording()">å¯¼å‡ºæ•°æ®</button>
            </div>
            
            <div id="recordingStatus" class="status recording">
                ğŸ”´ æ­£åœ¨å½•åˆ¶ä¸­... è¯·åœ¨ä¸Šæ–¹åŒºåŸŸè¿›è¡Œæ“ä½œ
            </div>
            
            <div class="stats" id="statsContainer">
                <!-- ç»Ÿè®¡ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="section">
            <h2>ğŸ“º å›æ”¾å±•ç¤º</h2>
            <div id="replayContainer" class="replay-container"></div>
        </div>
    </div>


    <script>
        /**
 * åŸç”ŸJSæ— æ„Ÿå½•å±å™¨
 * ä½¿ç”¨MutationObserver + äº‹ä»¶ç›‘å¬å®ç°
 */
        class NativeScreenRecorder {
            constructor(options = {}) {
                // é…ç½®å‚æ•°
                this.config = {
                    maskInputs: true,           // å±è”½è¾“å…¥å†…å®¹
                    maskText: false,            // å±è”½æ–‡æœ¬å†…å®¹
                    recordScroll: true,         // è®°å½•æ»šåŠ¨
                    recordClicks: true,         // è®°å½•ç‚¹å‡»
                    recordKeyPress: false,      // è®°å½•æŒ‰é”®ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
                    recordMouseMove: false,     // è®°å½•é¼ æ ‡ç§»åŠ¨ï¼ˆæ•°æ®é‡å¤§ï¼‰
                    sampling: {
                        mouseMove: 100,         // é¼ æ ‡ç§»åŠ¨é‡‡æ ·ç‡(ms)
                        scroll: 150             // æ»šåŠ¨é‡‡æ ·ç‡(ms)
                    },
                    maxEvents: 10000,           // æœ€å¤§äº‹ä»¶æ•°
                    ...options
                };

                // çŠ¶æ€ç®¡ç†
                this.isRecording = false;
                this.events = [];
                this.startTime = null;
                this.observer = null;
                this.eventListeners = [];

                // æ€§èƒ½ä¼˜åŒ–
                this.lastMouseMove = 0;
                this.lastScrollTime = 0;
                this.snapshotCache = new Map();

                console.log('ğŸ¥ åŸç”Ÿå½•å±å™¨åˆå§‹åŒ–å®Œæˆ');
            }

            /**
             * å¼€å§‹å½•åˆ¶
             */
            start() {
                if (this.isRecording) return;

                this.isRecording = true;
                this.startTime = Date.now();
                this.events = [];

                // 1. è®°å½•åˆå§‹å…¨é‡å¿«ç…§
                this.captureInitialSnapshot();

                // 2. å¯åŠ¨DOMå˜åŒ–ç›‘å¬
                this.startDOMMutationObserver();

                // 3. å¯åŠ¨äº‹ä»¶ç›‘å¬
                this.startEventListeners();

                console.log('ğŸ”´ åŸç”Ÿå½•å±å¼€å§‹');
                return true;
            }

            /**
             * æ•è·åˆå§‹é¡µé¢å¿«ç…§
             */
            captureInitialSnapshot() {
                const snapshot = {
                    type: 'full-snapshot',
                    timestamp: 0,
                    data: {
                        html: this.serializeDOM(document.documentElement),
                        url: window.location.href,
                        viewport: {
                            width: window.innerWidth,
                            height: window.innerHeight
                        },
                        timestamp: Date.now()
                    }
                };

                this.events.push(snapshot);
                console.log('ğŸ“¸ åˆå§‹å¿«ç…§å·²æ•è·');
            }

            /**
             * åºåˆ—åŒ–DOMèŠ‚ç‚¹
             */
            serializeDOM(node, depth = 0) {
                // æ·±åº¦é™åˆ¶ï¼Œé˜²æ­¢åºåˆ—åŒ–è¿‡æ·±
                if (depth > 20) return '[æ·±åº¦é™åˆ¶]';

                // å¤„ç†ä¸åŒèŠ‚ç‚¹ç±»å‹
                switch (node.nodeType) {
                    case Node.ELEMENT_NODE:
                        return this.serializeElement(node, depth);

                    case Node.TEXT_NODE:
                        return this.serializeTextNode(node);

                    case Node.COMMENT_NODE:
                        return `<!--${node.textContent}-->`;

                    default:
                        return '';
                }
            }

            /**
             * åºåˆ—åŒ–å…ƒç´ èŠ‚ç‚¹
             */
            serializeElement(element, depth) {
                // æ„å»ºæ ‡ç­¾
                const tagName = element.tagName.toLowerCase();
                let serialized = `<${tagName}`;

                // åºåˆ—åŒ–å±æ€§ï¼ˆæ’é™¤æ•æ„Ÿå±æ€§ï¼‰
                for (const attr of element.attributes) {
                    if (this.shouldSerializeAttribute(attr.name)) {
                        let value = attr.value;

                        // å¤„ç†è¾“å…¥æ¡†å†…å®¹å±è”½
                        if (this.config.maskInputs &&
                            (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA')) {
                            if (attr.name === 'value') {
                                value = this.maskValue(value);
                            }
                        }

                        serialized += ` ${attr.name}="${this.escapeHtml(value)}"`;
                    }
                }

                serialized += '>';

                // åºåˆ—åŒ–å­èŠ‚ç‚¹
                if (element.childNodes.length > 0) {
                    for (const child of element.childNodes) {
                        serialized += this.serializeDOM(child, depth + 1);
                    }
                }

                // é—­åˆæ ‡ç­¾ï¼ˆè‡ªé—­åˆæ ‡ç­¾ä¸éœ€è¦ï¼‰
                if (!this.isVoidElement(tagName)) {
                    serialized += `</${tagName}>`;
                }

                return serialized;
            }

            /**
             * åºåˆ—åŒ–æ–‡æœ¬èŠ‚ç‚¹
             */
            serializeTextNode(textNode) {
                let text = textNode.textContent || '';

                // æ–‡æœ¬å†…å®¹å±è”½
                if (this.config.maskText) {
                    text = this.maskText(text);
                }

                return this.escapeHtml(text);
            }

            /**
             * å¯åŠ¨DOMå˜åŒ–è§‚å¯Ÿè€…
             */
            startDOMMutationObserver() {
                this.observer = new MutationObserver((mutations) => {
                    if (!this.isRecording) return;

                    const timestamp = Date.now() - this.startTime;

                    mutations.forEach((mutation) => {
                        // è¿‡æ»¤ä¸å¿…è¦çš„å˜åŠ¨
                        if (this.shouldIgnoreMutation(mutation)) return;

                        const event = {
                            type: 'mutation',
                            timestamp,
                            data: this.serializeMutation(mutation)
                        };

                        this.addEvent(event);
                    });
                });

                // è§‚å¯Ÿæ•´ä¸ªæ–‡æ¡£çš„å˜åŒ–
                this.observer.observe(document.documentElement, {
                    childList: true,      // å­èŠ‚ç‚¹çš„æ·»åŠ /åˆ é™¤
                    attributes: true,     // å±æ€§çš„ä¿®æ”¹
                    characterData: true,  // æ–‡æœ¬å†…å®¹å˜åŒ–
                    subtree: true,        // æ‰€æœ‰åä»£èŠ‚ç‚¹
                    attributeOldValue: true,
                    characterDataOldValue: true
                });
            }

            /**
             * å¯åŠ¨äº‹ä»¶ç›‘å¬
             */
            startEventListeners() {
                // ç‚¹å‡»äº‹ä»¶
                if (this.config.recordClicks) {
                    const clickHandler = (e) => {
                        if (!this.isRecording) return;

                        const target = e.target;
                        const event = {
                            type: 'click',
                            timestamp: Date.now() - this.startTime,
                            data: {
                                x: e.clientX,
                                y: e.clientY,
                                target: this.getElementSelector(target),
                                tagName: target.tagName,
                                id: target.id,
                                className: target.className
                            }
                        };

                        this.addEvent(event);
                    };

                    document.addEventListener('click', clickHandler, true);
                    this.eventListeners.push({ type: 'click', handler: clickHandler });
                }

                // æ»šåŠ¨äº‹ä»¶ï¼ˆèŠ‚æµï¼‰
                if (this.config.recordScroll) {
                    const scrollHandler = () => {
                        if (!this.isRecording) return;

                        const now = Date.now();
                        if (now - this.lastScrollTime < this.config.sampling.scroll) return;

                        this.lastScrollTime = now;

                        const event = {
                            type: 'scroll',
                            timestamp: now - this.startTime,
                            data: {
                                scrollX: window.pageXOffset,
                                scrollY: window.pageYOffset,
                                viewport: {
                                    width: window.innerWidth,
                                    height: window.innerHeight
                                }
                            }
                        };

                        this.addEvent(event);
                    };

                    window.addEventListener('scroll', scrollHandler, { passive: true });
                    this.eventListeners.push({ type: 'scroll', handler: scrollHandler });
                }

                // é¼ æ ‡ç§»åŠ¨ï¼ˆé«˜é‡‡æ ·ç‡ä¸‹ä½¿ç”¨ï¼‰
                if (this.config.recordMouseMove) {
                    const mouseMoveHandler = (e) => {
                        if (!this.isRecording) return;

                        const now = Date.now();
                        if (now - this.lastMouseMove < this.config.sampling.mouseMove) return;

                        this.lastMouseMove = now;

                        const event = {
                            type: 'mousemove',
                            timestamp: now - this.startTime,
                            data: {
                                x: e.clientX,
                                y: e.clientY,
                                movementX: e.movementX,
                                movementY: e.movementY
                            }
                        };

                        this.addEvent(event);
                    };

                    document.addEventListener('mousemove', mouseMoveHandler, { passive: true });
                    this.eventListeners.push({ type: 'mousemove', handler: mouseMoveHandler });
                }

                // è¾“å…¥äº‹ä»¶ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
                if (this.config.recordKeyPress) {
                    const inputHandler = (e) => {
                        if (!this.isRecording) return;

                        const target = e.target;
                        const isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA';

                        if (!isInput) return;

                        const event = {
                            type: 'input',
                            timestamp: Date.now() - this.startTime,
                            data: {
                                target: this.getElementSelector(target),
                                value: this.config.maskInputs ? this.maskValue(target.value) : target.value,
                                inputType: e.inputType || 'unknown'
                            }
                        };

                        this.addEvent(event);
                    };

                    document.addEventListener('input', inputHandler, true);
                    this.eventListeners.push({ type: 'input', handler: inputHandler });
                }

                // é¡µé¢å¯è§æ€§å˜åŒ–
                const visibilityHandler = () => {
                    if (!this.isRecording) return;

                    const event = {
                        type: 'visibility',
                        timestamp: Date.now() - this.startTime,
                        data: {
                            state: document.visibilityState,
                            hidden: document.hidden
                        }
                    };

                    this.addEvent(event);
                };

                document.addEventListener('visibilitychange', visibilityHandler);
                this.eventListeners.push({ type: 'visibility', handler: visibilityHandler });
            }

            /**
             * åœæ­¢å½•åˆ¶
             */
            stop() {
                if (!this.isRecording) return null;

                this.isRecording = false;

                // åœæ­¢MutationObserver
                if (this.observer) {
                    this.observer.disconnect();
                    this.observer = null;
                }

                // ç§»é™¤äº‹ä»¶ç›‘å¬
                this.removeEventListeners();

                // æ·»åŠ ç»“æŸäº‹ä»¶
                const endEvent = {
                    type: 'end',
                    timestamp: Date.now() - this.startTime,
                    data: {
                        totalEvents: this.events.length,
                        duration: Date.now() - this.startTime
                    }
                };

                this.events.push(endEvent);

                console.log('â¹ï¸ å½•å±åœæ­¢ï¼Œäº‹ä»¶æ•°:', this.events.length);

                // ä¼˜åŒ–æ•°æ®
                const optimizedEvents = this.optimizeEvents();

                return {
                    events: optimizedEvents,
                    metadata: {
                        startTime: this.startTime,
                        duration: Date.now() - this.startTime,
                        eventCount: this.events.length,
                        url: window.location.href,
                        userAgent: navigator.userAgent
                    }
                };
            }

            /**
             * ä¼˜åŒ–äº‹ä»¶æ•°æ®ï¼ˆå¢é‡æ›´æ–°ï¼‰
             */
            optimizeEvents() {
                if (this.events.length <= 1) return this.events;

                const optimized = [this.events[0]]; // ä¿ç•™å®Œæ•´å¿«ç…§

                for (let i = 1; i < this.events.length; i++) {
                    const event = this.events[i];

                    // ç§»é™¤è¿‡äºé¢‘ç¹çš„é¼ æ ‡ç§»åŠ¨äº‹ä»¶
                    if (event.type === 'mousemove' && i > 1) {
                        const prevEvent = this.events[i - 1];
                        if (prevEvent.type === 'mousemove') {
                            const timeDiff = event.timestamp - prevEvent.timestamp;
                            const distance = Math.sqrt(
                                Math.pow(event.data.x - prevEvent.data.x, 2) +
                                Math.pow(event.data.y - prevEvent.data.y, 2)
                            );

                            // å¦‚æœæ—¶é—´é—´éš”çŸ­ä¸”ç§»åŠ¨è·ç¦»å°ï¼Œè·³è¿‡
                            if (timeDiff < 50 && distance < 5) continue;
                        }
                    }

                    optimized.push(event);
                }

                console.log(`ğŸ“Š ä¼˜åŒ–åäº‹ä»¶æ•°: ${optimized.length} (å‡å°‘${this.events.length - optimized.length})`);
                return optimized;
            }

            /**
             * æ·»åŠ äº‹ä»¶ï¼ˆå¸¦é™åˆ¶æ£€æŸ¥ï¼‰
             */
            addEvent(event) {
                // æ£€æŸ¥äº‹ä»¶æ•°é‡é™åˆ¶
                if (this.events.length >= this.config.maxEvents) {
                    console.warn('è¾¾åˆ°æœ€å¤§äº‹ä»¶æ•°é‡é™åˆ¶ï¼Œåœæ­¢å½•åˆ¶');
                    this.stop();
                    return;
                }

                this.events.push(event);

                // å®æ—¶æ•°æ®ç»Ÿè®¡
                if (this.events.length % 100 === 0) {
                    console.log(`ğŸ“ˆ å·²å½•åˆ¶ ${this.events.length} ä¸ªäº‹ä»¶`);
                }
            }

            /**
             * ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬
             */
            removeEventListeners() {
                this.eventListeners.forEach(({ type, handler }) => {
                    document.removeEventListener(type, handler, true);
                });

                window.removeEventListener('scroll', this.scrollHandler);
                this.eventListeners = [];
            }

            /**
             * è·å–å…ƒç´ é€‰æ‹©å™¨
             */
            getElementSelector(element) {
                if (!element || element === document.documentElement) return 'html';

                const parts = [];
                let current = element;

                while (current && current !== document.documentElement) {
                    let selector = current.tagName.toLowerCase();

                    if (current.id) {
                        selector += `#${current.id}`;
                        parts.unshift(selector);
                        break;
                    } else {
                        // æ·»åŠ ç±»å
                        if (current.className && typeof current.className === 'string') {
                            const classes = current.className.trim().split(/\s+/);
                            if (classes.length > 0) {
                                selector += `.${classes[0]}`;
                            }
                        }

                        // æ·»åŠ å…„å¼ŸèŠ‚ç‚¹ç´¢å¼•
                        const siblings = Array.from(current.parentNode.children);
                        const index = siblings.indexOf(current);
                        if (index > 0) {
                            selector += `:nth-child(${index + 1})`;
                        }

                        parts.unshift(selector);
                        current = current.parentNode;
                    }
                }

                return parts.join(' > ');
            }

            /**
             * åºåˆ—åŒ–Mutationè®°å½•
             */
            serializeMutation(mutation) {
                const data = {
                    type: mutation.type,
                    target: this.getElementSelector(mutation.target)
                };

                switch (mutation.type) {
                    case 'attributes':
                        data.attributeName = mutation.attributeName;
                        data.oldValue = mutation.oldValue;
                        data.newValue = mutation.target.getAttribute(mutation.attributeName);
                        break;

                    case 'characterData':
                        data.oldValue = mutation.oldValue;
                        data.newValue = mutation.target.textContent;
                        break;

                    case 'childList':
                        data.addedNodes = [];
                        data.removedNodes = [];

                        mutation.addedNodes.forEach(node => {
                            data.addedNodes.push(this.serializeDOM(node));
                        });

                        mutation.removedNodes.forEach(node => {
                            data.removedNodes.push(this.serializeDOM(node));
                        });
                        break;
                }

                return data;
            }

            /**
             * è¾…åŠ©æ–¹æ³•
             */
            shouldSerializeAttribute(attrName) {
                // æ’é™¤æ•æ„Ÿå±æ€§
                const excludeAttrs = ['password', 'autocomplete', 'creditcard', 'cvc'];
                return !excludeAttrs.some(exclude =>
                    attrName.toLowerCase().includes(exclude)
                );
            }

            shouldIgnoreMutation(mutation) {
                // å¿½ç•¥script/styleæ ‡ç­¾çš„å˜åŒ–
                const tagName = mutation.target.tagName;
                if (tagName === 'SCRIPT' || tagName === 'STYLE') {
                    return true;
                }

                // å¿½ç•¥å¾®å°æ–‡æœ¬å˜åŒ–
                if (mutation.type === 'characterData') {
                    const oldValue = mutation.oldValue || '';
                    const newValue = mutation.target.textContent || '';
                    return oldValue.trim() === newValue.trim();
                }

                return false;
            }

            maskValue(value) {
                if (!value) return '';
                return '*'.repeat(Math.min(value.length, 10));
            }

            maskText(text) {
                if (text.length < 10) return text;
                return text.substring(0, 3) + '...' + text.substring(text.length - 3);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            isVoidElement(tagName) {
                const voidElements = [
                    'area', 'base', 'br', 'col', 'embed', 'hr',
                    'img', 'input', 'link', 'meta', 'param',
                    'source', 'track', 'wbr'
                ];
                return voidElements.includes(tagName);
            }

            /**
             * å¯¼å‡ºæ•°æ®
             */
            exportData(format = 'json') {
                const data = {
                    events: this.events,
                    metadata: {
                        version: '1.0',
                        recordedAt: new Date().toISOString(),
                        url: window.location.href
                    }
                };

                switch (format) {
                    case 'json':
                        return JSON.stringify(data, null, 2);

                    case 'compressed':
                        return this.compressData(data);

                    default:
                        return data;
                }
            }

            /**
             * å‹ç¼©æ•°æ®ï¼ˆç®€å•å®ç°ï¼‰
             */
            compressData(data) {
                const jsonStr = JSON.stringify(data);

                // ç®€å•çš„é‡å¤å­—ç¬¦ä¸²å‹ç¼©
                let compressed = jsonStr;
                const repeated = jsonStr.match(/(.{10,}?)\1+/g);

                if (repeated) {
                    repeated.forEach((repeat, index) => {
                        const unique = repeat.substring(0, repeat.length / 2);
                        compressed = compressed.replace(
                            new RegExp(repeat.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'),
                            `[R${index}:${unique.length}]`
                        );
                    });
                }

                return compressed;
            }

            /**
             * è·å–å½“å‰çŠ¶æ€
             */
            getStatus() {
                return {
                    isRecording: this.isRecording,
                    eventCount: this.events.length,
                    startTime: this.startTime,
                    duration: this.isRecording ? Date.now() - this.startTime : 0,
                    memoryUsage: this.getMemoryUsage()
                };
            }

            getMemoryUsage() {
                const dataStr = JSON.stringify(this.events);
                const bytes = new TextEncoder().encode(dataStr).length;

                return {
                    bytes,
                    kb: (bytes / 1024).toFixed(2),
                    mb: (bytes / (1024 * 1024)).toFixed(3)
                };
            }
        }

        /**
         * åŸç”Ÿå½•å±å›æ”¾å¼•æ“
         */
        class NativeScreenReplayer {
            constructor(containerId, options = {}) {
                this.container = document.getElementById(containerId);
                this.options = {
                    speed: 1.0,
                    autoplay: false,
                    showControls: true,
                    loop: false,
                    ...options
                };

                this.events = [];
                this.currentIndex = 0;
                this.isPlaying = false;
                this.startTime = null;
                this.timer = null;
                this.snapshot = null;

                if (this.options.showControls) {
                    this.createControls();
                }

                console.log('ğŸ¬ å›æ”¾å¼•æ“åˆå§‹åŒ–å®Œæˆ');
            }

            /**
             * åŠ è½½å½•åˆ¶æ•°æ®
             */
            load(data) {
                if (typeof data === 'string') {
                    data = JSON.parse(data);
                }

                this.events = data.events || data;

                // æŸ¥æ‰¾å®Œæ•´å¿«ç…§
                this.snapshot = this.events.find(e => e.type === 'full-snapshot');

                if (!this.snapshot) {
                    console.error('æœªæ‰¾åˆ°åˆå§‹å¿«ç…§');
                    return false;
                }

                console.log(`ğŸ“ åŠ è½½ ${this.events.length} ä¸ªäº‹ä»¶`);
                return true;
            }

            /**
             * å¼€å§‹å›æ”¾
             */
            play() {
                if (this.isPlaying) return;

                this.isPlaying = true;
                this.startTime = Date.now();
                this.currentIndex = 0;

                // 1. æ¢å¤åˆå§‹å¿«ç…§
                this.restoreSnapshot();

                // 2. å¼€å§‹æ’­æ”¾äº‹ä»¶
                this.playNextEvent();

                this.updateControls();
                console.log('â–¶ï¸ å›æ”¾å¼€å§‹');
            }

            /**
             * æ¢å¤åˆå§‹å¿«ç…§
             */
            restoreSnapshot() {
                if (!this.snapshot) return;

                // åˆ›å»ºiframeéš”ç¦»ç¯å¢ƒï¼ˆæ¨èï¼‰
                if (!this.iframe) {
                    this.iframe = document.createElement('iframe');
                    this.iframe.style.cssText = `
                width: 100%;
                height: 100%;
                border: none;
                background: white;
            `;
                    this.container.innerHTML = '';
                    this.container.appendChild(this.iframe);

                    // ç­‰å¾…iframeåŠ è½½
                    this.iframe.onload = () => {
                        this.applySnapshot(this.snapshot.data.html);
                    };

                    this.iframe.srcdoc = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { margin: 0; padding: 20px; }
                        .replay-highlight { outline: 2px solid #f56565; }
                    </style>
                </head>
                <body></body>
                </html>
            `;
                } else {
                    this.applySnapshot(this.snapshot.data.html);
                }
            }

            /**
             * åº”ç”¨å¿«ç…§HTML
             */
            applySnapshot(html) {
                if (!this.iframe) return;

                const doc = this.iframe.contentDocument;
                if (!doc) return;

                // ä¿å­˜æ»šåŠ¨ä½ç½®
                const scrollX = doc.documentElement.scrollLeft;
                const scrollY = doc.documentElement.scrollTop;

                // åº”ç”¨HTML
                doc.body.innerHTML = html;

                // æ¢å¤æ»šåŠ¨ä½ç½®
                doc.documentElement.scrollLeft = scrollX;
                doc.documentElement.scrollTop = scrollY;
            }

            /**
             * æ’­æ”¾ä¸‹ä¸€ä¸ªäº‹ä»¶
             */
            playNextEvent() {
                if (!this.isPlaying || this.currentIndex >= this.events.length) {
                    this.stop();
                    return;
                }

                const event = this.events[this.currentIndex];
                const nextEvent = this.events[this.currentIndex + 1];

                // è®¡ç®—å»¶è¿Ÿ
                let delay = 0;
                if (nextEvent) {
                    delay = (nextEvent.timestamp - event.timestamp) / this.options.speed;
                }

                // åº”ç”¨å½“å‰äº‹ä»¶
                this.applyEvent(event);

                // å‡†å¤‡ä¸‹ä¸€ä¸ªäº‹ä»¶
                this.currentIndex++;

                if (delay > 0) {
                    this.timer = setTimeout(() => {
                        this.playNextEvent();
                    }, delay);
                } else {
                    this.playNextEvent();
                }

                this.updateProgress();
            }

            /**
             * åº”ç”¨å•ä¸ªäº‹ä»¶
             */
            applyEvent(event) {
                if (!this.iframe) return;

                const doc = this.iframe.contentDocument;
                if (!doc) return;

                try {
                    switch (event.type) {
                        case 'mutation':
                            this.applyMutation(event.data, doc);
                            break;

                        case 'click':
                            this.highlightClick(event.data, doc);
                            break;

                        case 'scroll':
                            this.applyScroll(event.data, doc);
                            break;

                        case 'mousemove':
                            // å¯é€‰ï¼šæ˜¾ç¤ºé¼ æ ‡è½¨è¿¹
                            break;

                        case 'input':
                            this.applyInput(event.data, doc);
                            break;
                    }
                } catch (error) {
                    console.warn(`åº”ç”¨äº‹ä»¶å¤±è´¥: ${event.type}`, error);
                }
            }

            /**
             * åº”ç”¨DOMå˜åŒ–
             */
            applyMutation(data, doc) {
                const target = this.querySelector(data.target, doc);
                if (!target) {
                    console.warn(`æœªæ‰¾åˆ°ç›®æ ‡å…ƒç´ : ${data.target}`);
                    return;
                }

                switch (data.type) {
                    case 'attributes':
                        if (data.newValue !== null) {
                            target.setAttribute(data.attributeName, data.newValue);
                        } else {
                            target.removeAttribute(data.attributeName);
                        }
                        break;

                    case 'characterData':
                        target.textContent = data.newValue;
                        break;

                    case 'childList':
                        // ç§»é™¤èŠ‚ç‚¹
                        data.removedNodes.forEach(nodeHtml => {
                            // ç®€åŒ–å®ç°ï¼šé€šè¿‡é€‰æ‹©å™¨ç§»é™¤
                        });

                        // æ·»åŠ èŠ‚ç‚¹
                        data.addedNodes.forEach(nodeHtml => {
                            const temp = doc.createElement('div');
                            temp.innerHTML = nodeHtml;
                            if (temp.firstChild) {
                                target.appendChild(temp.firstChild);
                            }
                        });
                        break;
                }
            }

            /**
             * é«˜äº®ç‚¹å‡»äº‹ä»¶
             */
            highlightClick(data, doc) {
                const target = this.querySelector(data.target, doc);
                if (!target) return;

                // æ·»åŠ é«˜äº®æ ·å¼
                target.classList.add('replay-highlight');

                // ç§»é™¤é«˜äº®
                setTimeout(() => {
                    target.classList.remove('replay-highlight');
                }, 500);
            }

            /**
             * åº”ç”¨æ»šåŠ¨
             */
            applyScroll(data, doc) {
                doc.documentElement.scrollLeft = data.scrollX;
                doc.documentElement.scrollTop = data.scrollY;
            }

            /**
             * åº”ç”¨è¾“å…¥
             */
            applyInput(data, doc) {
                const target = this.querySelector(data.target, doc);
                if (!target || !target.value !== undefined) return;

                target.value = data.value;
            }

            /**
             * å®‰å…¨çš„é€‰æ‹©å™¨æŸ¥è¯¢
             */
            querySelector(selector, doc) {
                try {
                    // ç®€åŒ–é€‰æ‹©å™¨æŸ¥è¯¢
                    if (selector.includes('#') && !selector.includes(' ')) {
                        const id = selector.split('#')[1];
                        return doc.getElementById(id);
                    }

                    // å›é€€åˆ°é€šç”¨æŸ¥è¯¢
                    return doc.querySelector(selector);
                } catch (error) {
                    console.warn(`é€‰æ‹©å™¨æŸ¥è¯¢å¤±è´¥: ${selector}`);
                    return null;
                }
            }

            /**
             * æš‚åœå›æ”¾
             */
            pause() {
                this.isPlaying = false;
                if (this.timer) {
                    clearTimeout(this.timer);
                    this.timer = null;
                }

                this.updateControls();
                console.log('â¸ï¸ å›æ”¾æš‚åœ');
            }

            /**
             * åœæ­¢å›æ”¾
             */
            stop() {
                this.isPlaying = false;
                this.currentIndex = 0;

                if (this.timer) {
                    clearTimeout(this.timer);
                    this.timer = null;
                }

                this.updateControls();
                console.log('â¹ï¸ å›æ”¾åœæ­¢');
            }

            /**
             * è·³è½¬åˆ°æŒ‡å®šæ—¶é—´
             */
            seekTo(time) {
                this.pause();

                // æ‰¾åˆ°æ—¶é—´ç‚¹ä¹‹å‰çš„æœ€æ–°å¿«ç…§
                let snapshotIndex = 0;
                for (let i = 0; i < this.events.length; i++) {
                    if (this.events[i].timestamp <= time &&
                        this.events[i].type === 'full-snapshot') {
                        snapshotIndex = i;
                    }
                }

                // æ¢å¤å¿«ç…§
                this.snapshot = this.events[snapshotIndex];
                this.restoreSnapshot();

                // åº”ç”¨å¿«ç…§åçš„äº‹ä»¶
                this.currentIndex = snapshotIndex + 1;
                while (this.currentIndex < this.events.length &&
                    this.events[this.currentIndex].timestamp <= time) {
                    this.applyEvent(this.events[this.currentIndex]);
                    this.currentIndex++;
                }

                this.updateProgress();
            }

            /**
             * åˆ›å»ºæ§åˆ¶UI
             */
            createControls() {
                this.controls = document.createElement('div');
                this.controls.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            font-family: Arial, sans-serif;
        `;

                // æ’­æ”¾/æš‚åœæŒ‰é’®
                this.playBtn = document.createElement('button');
                this.playBtn.textContent = 'â–¶';
                this.playBtn.onclick = () => this.togglePlay();

                // åœæ­¢æŒ‰é’®
                this.stopBtn = document.createElement('button');
                this.stopBtn.textContent = 'â¹';
                this.stopBtn.onclick = () => this.stop();

                // è¿›åº¦æ¡
                this.progressBar = document.createElement('input');
                this.progressBar.type = 'range';
                this.progressBar.min = 0;
                this.progressBar.max = 100;
                this.progressBar.style.width = '200px';
                this.progressBar.oninput = (e) => {
                    const percent = e.target.value;
                    const totalTime = this.getTotalDuration();
                    this.seekTo((percent / 100) * totalTime);
                };

                // æ—¶é—´æ˜¾ç¤º
                this.timeDisplay = document.createElement('span');
                this.timeDisplay.style.minWidth = '80px';

                // é€Ÿåº¦æ§åˆ¶
                this.speedSelect = document.createElement('select');
                [0.5, 1.0, 1.5, 2.0].forEach(speed => {
                    const option = document.createElement('option');
                    option.value = speed;
                    option.textContent = `${speed}x`;
                    if (speed === this.options.speed) option.selected = true;
                    this.speedSelect.appendChild(option);
                });
                this.speedSelect.onchange = (e) => {
                    this.options.speed = parseFloat(e.target.value);
                    if (this.isPlaying) {
                        this.pause();
                        this.play();
                    }
                };

                // ç»„è£…æ§ä»¶
                this.controls.appendChild(this.playBtn);
                this.controls.appendChild(this.stopBtn);
                this.controls.appendChild(this.progressBar);
                this.controls.appendChild(this.timeDisplay);
                this.controls.appendChild(this.speedSelect);

                document.body.appendChild(this.controls);
            }

            /**
             * æ›´æ–°æ§åˆ¶UI
             */
            updateControls() {
                if (!this.controls) return;

                this.playBtn.textContent = this.isPlaying ? 'â¸' : 'â–¶';
                this.updateProgress();
            }

            /**
             * æ›´æ–°è¿›åº¦æ˜¾ç¤º
             */
            updateProgress() {
                if (!this.progressBar || !this.timeDisplay) return;

                const currentTime = this.currentIndex < this.events.length
                    ? this.events[this.currentIndex].timestamp
                    : this.getTotalDuration();

                const totalTime = this.getTotalDuration();
                const percent = totalTime > 0 ? (currentTime / totalTime) * 100 : 0;

                this.progressBar.value = percent;

                // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
                const formatTime = (ms) => {
                    const seconds = Math.floor(ms / 1000);
                    const minutes = Math.floor(seconds / 60);
                    return `${minutes}:${(seconds % 60).toString().padStart(2, '0')}`;
                };

                this.timeDisplay.textContent =
                    `${formatTime(currentTime)} / ${formatTime(totalTime)}`;
            }

            /**
             * è·å–æ€»æ—¶é•¿
             */
            getTotalDuration() {
                if (this.events.length === 0) return 0;
                return this.events[this.events.length - 1].timestamp;
            }

            /**
             * åˆ‡æ¢æ’­æ”¾çŠ¶æ€
             */
            togglePlay() {
                if (this.isPlaying) {
                    this.pause();
                } else {
                    if (this.currentIndex >= this.events.length) {
                        this.currentIndex = 0;
                    }
                    this.play();
                }
            }

            /**
             * é”€æ¯å®ä¾‹
             */
            destroy() {
                this.stop();
                if (this.controls && this.controls.parentNode) {
                    this.controls.parentNode.removeChild(this.controls);
                }
                if (this.iframe && this.iframe.parentNode) {
                    this.iframe.parentNode.removeChild(this.iframe);
                }
            }
        }

         // å…¨å±€å®ä¾‹
        let recorder = null;
        let replayer = null;
        let recordingData = null;
        
        // æ¼”ç¤ºåŒºåŸŸäº¤äº’å‡½æ•°
        function addDemoItem() {
            const list = document.getElementById('itemList');
            const item = document.createElement('div');
            item.className = 'demo-item';
            item.style.cssText = `
                padding: 10px;
                margin: 5px 0;
                background: #e2e8f0;
                border-radius: 4px;
                border-left: 4px solid #667eea;
            `;
            item.textContent = `é¡¹ç›® ${list.children.length + 1} - ${new Date().toLocaleTimeString()}`;
            list.appendChild(item);
        }
        
        function changeDemoColor() {
            const colors = ['#ffebee', '#e8f5e9', '#e3f2fd', '#fff3e0', '#f3e5f5'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            document.getElementById('demoArea').style.backgroundColor = color;
        }
        
        function clearDemoItems() {
            document.getElementById('itemList').innerHTML = '';
        }
        
        // å½•åˆ¶æ§åˆ¶
        function startNativeRecording() {
            // åˆå§‹åŒ–å½•åˆ¶å™¨
            recorder = new NativeScreenRecorder({
                maskInputs: true,
                recordScroll: true,
                recordClicks: true,
                recordMouseMove: false,
                maxEvents: 5000
            });
            
            // å¼€å§‹å½•åˆ¶
            recorder.start();
            
            // æ›´æ–°UI
            document.getElementById('recordingStatus').classList.add('show');
            document.getElementById('replayBtn').disabled = true;
            
            // å¼€å§‹æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
            
            console.log('ğŸ¥ åŸç”Ÿå½•å±å·²å¼€å§‹');
        }
        
        function stopNativeRecording() {
            if (!recorder) return;
            
            // åœæ­¢å½•åˆ¶
            recordingData = recorder.stop();
            
            // æ›´æ–°UI
            document.getElementById('recordingStatus').classList.remove('show');
            document.getElementById('replayBtn').disabled = false;
            
            // æ˜¾ç¤ºç»Ÿè®¡
            showFinalStats();
            
            console.log('ğŸ“Š å½•åˆ¶å®Œæˆï¼Œæ•°æ®å¤§å°:', 
                recorder.getMemoryUsage().kb + ' KB');
        }
        
        function replayRecording() {
            if (!recordingData || !recordingData.events) {
                alert('è¯·å…ˆå½•åˆ¶ä¸€äº›å†…å®¹ï¼');
                return;
            }
            
            // åˆå§‹åŒ–å›æ”¾å™¨
            replayer = new NativeScreenReplayer('replayContainer', {
                speed: 1.0,
                autoplay: true,
                showControls: true
            });
            
            // åŠ è½½æ•°æ®
            replayer.load(recordingData);
            
            // å¼€å§‹å›æ”¾
            replayer.play();
            
            console.log('ğŸ¬ å¼€å§‹å›æ”¾');
        }
        
        function exportRecording() {
            if (!recorder || !recorder.events.length) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼');
                return;
            }
            
            const data = recorder.exportData('json');
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const a = document.createElement('a');
            a.href = url;
            a.download = `recording-${Date.now()}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            
            console.log('ğŸ’¾ æ•°æ®å·²å¯¼å‡º');
        }
        
        // ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            if (!recorder || !recorder.isRecording) return;
            
            const stats = recorder.getStatus();
            const container = document.getElementById('statsContainer');
            
            container.innerHTML = `
                <div class="stat-card">
                    <strong>äº‹ä»¶æ•°é‡</strong>
                    <div style="font-size: 24px; color: #667eea;">${stats.eventCount}</div>
                </div>
                <div class="stat-card">
                    <strong>å½•åˆ¶æ—¶é•¿</strong>
                    <div style="font-size: 24px; color: #48bb78;">${(stats.duration/1000).toFixed(1)}s</div>
                </div>
                <div class="stat-card">
                    <strong>å†…å­˜ä½¿ç”¨</strong>
                    <div style="font-size: 24px; color: #ed8936;">${stats.memoryUsage.kb} KB</div>
                </div>
                <div class="stat-card">
                    <strong>çŠ¶æ€</strong>
                    <div style="font-size: 24px; color: #f56565;">${stats.isRecording ? 'å½•åˆ¶ä¸­' : 'å·²åœæ­¢'}</div>
                </div>
            `;
            
            // ç»§ç»­æ›´æ–°
            setTimeout(updateStats, 1000);
        }
        
        function showFinalStats() {
            if (!recordingData) return;
            
            const stats = recorder.getStatus();
            const container = document.getElementById('statsContainer');
            
            container.innerHTML = `
                <div class="stat-card">
                    <strong>å½•åˆ¶æ‘˜è¦</strong>
                    <div>äº‹ä»¶: ${stats.eventCount}</div>
                    <div>æ—¶é•¿: ${(stats.duration/1000).toFixed(1)}ç§’</div>
                    <div>å¤§å°: ${stats.memoryUsage.kb} KB</div>
                </div>
                <div class="stat-card">
                    <strong>æ•°æ®ä¿¡æ¯</strong>
                    <div>URL: ${new URL(recordingData.metadata.url).hostname}</div>
                    <div>æ—¶é—´: ${new Date(recordingData.metadata.startTime).toLocaleTimeString()}</div>
                    <div>è®¾å¤‡: ${navigator.userAgent.substring(0, 50)}...</div>
                </div>
            `;
        }
        
        // é¡µé¢å¸è½½æ—¶åœæ­¢å½•åˆ¶
        window.addEventListener('beforeunload', () => {
            if (recorder && recorder.isRecording) {
                recorder.stop();
                console.log('ğŸšª é¡µé¢å…³é—­ï¼Œå½•åˆ¶å·²è‡ªåŠ¨åœæ­¢');
            }
        });
        
        // åˆå§‹åŒ–æ¼”ç¤º
        window.addEventListener('load', () => {
            // æ·»åŠ å‡ ä¸ªåˆå§‹é¡¹ç›®
            for (let i = 0; i < 2; i++) {
                setTimeout(addDemoItem, 100 * i);
            }
            
            console.log('âœ… æ¼”ç¤ºé¡µé¢å·²åŠ è½½');
            console.log('ğŸ’¡ ç‚¹å‡»"å¼€å§‹æ— æ„Ÿå½•åˆ¶"æŒ‰é’®ï¼Œç„¶ååœ¨æ¼”ç¤ºåŒºåŸŸè¿›è¡Œæ“ä½œ');
        });
    </script>
</body>

</html>